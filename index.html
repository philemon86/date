<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>腓利門給揪嗎</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f0e4d7;
        color: #333;
        margin: 0;
        padding: 0;
    }
    .calendar-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-sizing: border-box;
    }
    .calendar-header {
        text-align: center;
        margin-bottom: 20px;
    }
    .calendar-header h1 {
        margin: 0;
        font-size: 24px;
        color: #8b4513;
    }
    .calendar-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
    }
    .calendar-nav select {
        padding: 10px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #8b4513;
        color: #fff;
        margin: 0 10px;
    }
    .calendar-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        table-layout: fixed;
    }
    .calendar-table th, .calendar-table td {
        border: 1px solid #ccc;
        padding: 5px;
        text-align: center;
        word-wrap: break-word;
    }
    .calendar-table th {
        background-color: #eee;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    .calendar-table td {
        height: 60px;
        position: relative;
    }
    .calendar-table .weekend {
        background-color: #f2e6d9;
    }
    .calendar-table .holiday {
        background-color: #f2e6d9;
    }
    .calendar-table td[data-event] {
        position: relative;
    }
    .calendar-table td[data-event]:hover .note {
        display: block;
    }
    .note {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 5px;
        white-space: nowrap;
        z-index: 10;
    }
    .delete-mode .calendar-table td[data-event] {
        cursor: pointer;
    }
    .delete-mode .calendar-table td[data-event]:hover {
        background-color: red;
    }
    .today {
        background-color: #ffeb3b;
    }
    .leave {
        color: red;
        font-weight: bold;
    }
    .stats {
        margin-bottom: 20px;
    }
    .stats h2 {
        font-size: 20px;
        color: #8b4513;
    }
    .stats p {
        font-size: 16px;
    }
    .event-input {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }
    .event-input div {
        margin-bottom: 10px;
    }
    .event-input label {
        font-weight: bold;
        margin-right: 10px;
    }
    .event-input textarea {
        width: 100%;
        height: 100px;
        padding: 5px;
        font-size: 16px;
        margin-right: 10px;
        box-sizing: border-box;
    }
    .actions {
        display: flex;
        justify-content: flex-end;
    }
    .actions button {
        padding: 10px 20px;
        font-size: 16px;
        margin-left: 10px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #d2b48c;
        color: #fff;
    }
    .actions button.active {
        background-color: #8b4513;
    }
    .actions button:hover {
        background-color: #a0522d;
    }
    .report {
        margin-bottom: 20px;
    }
    .report h2 {
        font-size: 20px;
        color: #8b4513;
    }
    .report p {
        font-size: 16px;
    }
    .holiday-input {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
    }
    .holiday-input div {
        margin-bottom: 10px;
    }
    .holiday-input label {
        font-weight: bold;
        margin-right: 10px;
    }
    .holiday-input input {
        padding: 5px;
        font-size: 16px;
        margin-right: 10px;
        box-sizing: border-box;
    }
    @media (max-width: 600px) {
        .calendar-table th, .calendar-table td {
            padding: 2px;
        }
        .calendar-nav select {
            padding: 5px;
            font-size: 14px;
        }
        .event-input textarea {
            height: 80px;
        }
    }
</style>
</head>
<body>
<div class="calendar-container">
    <div class="calendar-header">
        <h1 id="calendar-title">2025年腓利門給揪嗎</h1>
    </div>
    <div class="calendar-nav">
        <select id="year-select" onchange="changeYear()">
            <!-- Year options will be populated by JavaScript -->
        </select>
        <select id="month-select" onchange="changeMonth()">
            <!-- Month options will be populated by JavaScript -->
        </select>
    </div>
    <div class="report">
        <h2>近三日匯報彙整</h2>
        <div id="report-content">
            <!-- Recent 3-day report will be generated here -->
        </div>
    </div>
    <table class="calendar-table">
        <thead>
            <tr>
                <th>日期</th>
                <th>星期</th>
                <th>總會活動</th>
                <th>榮源</th>
                <th>畀予</th>
                <th>雅慧</th>
                <th>凱琪</th>
            </tr>
        </thead>
        <tbody id="calendar-body">
            <!-- Generate rows based on selected month -->
        </tbody>
    </table>
    <div class="stats">
        <h2>統計資訊</h2>
        <p>榮源 - 書展天數：<span id="stat-ry-days"></span>，次數：<span id="stat-ry-times"></span>，請假天數：<span id="stat-ry-leave"></span></p>
        <p>畀予 - 書展天數：<span id="stat-py-days"></span>，次數：<span id="stat-py-times"></span>，請假天數：<span id="stat-py-leave"></span></p>
        <p>雅慧 - 書展天數：<span id="stat-yh-days"></span>，次數：<span id="stat-yh-times"></span>，請假天數：<span id="stat-yh-leave"></span></p>
        <p>凱琪 - 書展天數：<span id="stat-kq-days"></span>，次數：<span id="stat-kq-times"></span>，請假天數：<span id="stat-kq-leave"></span></p>
    </div>
    <div class="event-input">
        <div>
            <label for="event-textarea">輸入行程：</label>
            <textarea id="event-textarea" placeholder="例如：總會活動.6/10-6/14.學生靈恩會&#10;畀予.6/25-6/26.嘉義書展.隔天請整天"></textarea>
        </div>
        <button onclick="addEvents()">確認</button>
        <button onclick="clearCurrentYearEvents()">刪除所有設定</button>
    </div>
    <div class="actions">
        <button onclick="toggleDeleteMode()" id="delete-mode-btn">刪除模式</button>
        <button onclick="exportCSV()">導出CSV</button>
    </div>
    <div class="holiday-input">
        <h2>變更當年度假期</h2>
        <div>
            <label for="holiday-date">日期 (年/月/日):</label>
            <input type="text" id="holiday-date" placeholder="例如: 2024/2/10">
        </div>
        <div>
            <label for="holiday-name">假期名稱:</label>
            <input type="text" id="holiday-name" placeholder="例如: 節日名稱">
        </div>
        <button onclick="addHoliday()">新增假期</button>
        <button onclick="removeHoliday()">刪除假期</button>
    </div>
</div>

<script>
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let eventsData = [];
    let deleteMode = false;
    let lastEvent = null;
    let lastEventTime = null;

    let holidays = {
        '2024/1/1': '元旦',
        '2024/1/6': '雅慧生日',
        '2024/1/7': '畀予生日',
        '2024/2/28': '和平紀念日',
        '2024/5/1': '勞動節',
        '2024/9/6': '榮源生日',
        '2024/9/11': '凱琪生日',
        '2024/10/10': '雙十節',
    };

    document.addEventListener('DOMContentLoaded', function() {
        populateYearSelect();
        populateMonthSelect();
        document.getElementById('calendar-title').innerText = `${currentYear}年腓利門給揪嗎`;
        loadEvents();
        generateCalendar(currentYear, currentMonth);
        renderEvents();
        updateStats();
        generateRecentReport();
    });

    function populateYearSelect() {
        const yearSelect = document.getElementById('year-select');
        yearSelect.innerHTML = '';
        for (let i = currentYear; i <= currentYear + 3; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.innerText = `${i}年`;
            if (i === currentYear) {
                option.selected = true;
            }
            yearSelect.appendChild(option);
        }
    }

    function changeYear() {
        currentYear = parseInt(document.getElementById('year-select').value, 10);
        document.getElementById('calendar-title').innerText = `${currentYear}年腓利門給揪嗎`;
        generateCalendar(currentYear, currentMonth);
        renderEvents();
        updateStats();
        generateRecentReport();
    }

    function populateMonthSelect() {
        const monthSelect = document.getElementById('month-select');
        monthSelect.innerHTML = '';
        for (let i = 0; i < 12; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.innerText = `${i + 1}月`;
            if (i === currentMonth) {
                option.selected = true;
            }
            monthSelect.appendChild(option);
        }
    }

    function changeMonth() {
        currentMonth = parseInt(document.getElementById('month-select').value, 10);
        document.getElementById('calendar-title').innerText = `${currentYear}年腓利門給揪嗎`;
        generateCalendar(currentYear, currentMonth);
        renderEvents();
        updateStats();
        generateRecentReport();
    }

    function generateCalendar(year, month) {
        const calendarBody = document.getElementById('calendar-body');
        calendarBody.innerHTML = '';
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDay = new Date(year, month, 1).getDay();
        const today = new Date();

        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];

        for (let day = 1; day <= daysInMonth; day++) {
            const row = document.createElement('tr');
            const dateCell = document.createElement('td');
            dateCell.innerText = day;
            const weekdayCell = document.createElement('td');
            weekdayCell.innerText = weekdays[(startDay + day - 1) % 7];
            if ((startDay + day - 1) % 7 === 0 || (startDay + day - 1) % 7 === 6) {
                row.classList.add('weekend');
            }

            const dateStr = `${year}/${month + 1}/${day}`;
            if (holidays[dateStr]) {
                row.classList.add('holiday');
                dateCell.innerText += ` (${holidays[dateStr]})`;
            }

            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dateCell.innerHTML += ' ★';
                row.classList.add('today');
            }
            row.appendChild(dateCell);
            row.appendChild(weekdayCell);

            for (let i = 0; i < 5; i++) {
                const cell = document.createElement('td');
                cell.setAttribute('data-date', `${year}-${month + 1}-${day}`);
                cell.setAttribute('data-person', i === 0 ? '總會活動' : ['榮源', '畀予', '雅慧', '凱琪'][i - 1]);
                row.appendChild(cell);
            }
            calendarBody.appendChild(row);
        }
    }

    function addEvents() {
        const eventText = document.getElementById('event-textarea').value.trim();
        if (!eventText) {
            alert('請輸入行程');
            return;
        }

        const now = new Date();
        if (lastEvent && eventText === lastEvent && (now - lastEventTime) < 10000) {
            if (!confirm('重複的行程在十秒內被輸入，確定要送出嗎？')) {
                return;
            }
        }

        lastEvent = eventText;
        lastEventTime = now;

        const events = eventText.split('\n').map(line => line.split('.'));
        for (let i = 0; i < events.length; i++) {
            const event = events[i];
            if (event.length < 3 || event.length > 4) {
                alert(`第 ${i + 1} 行的行程格式錯誤，請重新輸入`);
                return;
            }

            const [type, dateRange, content, note] = event;
            const [startDateStr, endDateStr] = dateRange.split('-').map(date => date.trim());

            const startDateParts = startDateStr.split('/');
            const endDateParts = endDateStr ? endDateStr.split('/') : startDateParts;

            if (startDateParts.length !== 2 || endDateParts.length !== 2 || isNaN(parseInt(startDateParts[0], 10)) || isNaN(parseInt(startDateParts[1], 10))) {
                alert(`第 ${i + 1} 行的日期格式錯誤，請使用 "月/日" 格式`);
                return;
            }

            const startDate = new Date(currentYear, parseInt(startDateParts[0], 10) - 1, parseInt(startDateParts[1], 10));
            const endDate = new Date(currentYear, parseInt(endDateParts[0], 10) - 1, parseInt(endDateParts[1], 10));

            if (startDate.getMonth() !== parseInt(startDateParts[0], 10) - 1 || endDate.getMonth() !== parseInt(endDateParts[0], 10) - 1 || !(startDate instanceof Date && !isNaN(startDate)) || !(endDate instanceof Date && !isNaN(endDate))) {
                alert(`第 ${i + 1} 行的日期格式錯誤，請重新輸入`);
                return;
            }

            console.log('Adding event:', {
                type: type.trim(),
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
                content: content.trim(),
                note: note ? note.trim() : ''
            });

            // Handle events that span across months
            let tempDate = new Date(startDate);
            while (tempDate <= endDate) {
                const tempEndDate = new Date(tempDate.getFullYear(), tempDate.getMonth() + 1, 0);
                const partialEndDate = tempEndDate > endDate ? endDate : tempEndDate;
                eventsData.push({
                    type: type.trim(),
                    startDate: tempDate.toISOString(),
                    endDate: partialEndDate.toISOString(),
                    content: content.trim(),
                    note: note ? note.trim() : ''
                });
                tempDate = new Date(tempEndDate);
                tempDate.setDate(tempDate.getDate() + 1);
            }
        }

        saveEvents();
        renderEvents();
        updateStats();
        generateRecentReport();
    }

    function renderEvents() {
        const calendarBody = document.getElementById('calendar-body').rows;
        for (let row of calendarBody) {
            for (let cell of row.cells) {
                if (cell.getAttribute('data-date') && cell.getAttribute('data-person')) {
                    cell.innerHTML = '';
                    cell.style.backgroundColor = '';
                    cell.onclick = null; // Reset click event
                }
            }
        }

        eventsData.forEach(event => {
            const startDate = new Date(event.startDate);
            const endDate = new Date(event.endDate);
            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                if (date.getFullYear() === currentYear && date.getMonth() === currentMonth) {
                    const rowIndex = date.getDate() - 1;
                    const calendarRow = calendarBody[rowIndex];
                    if (calendarRow) {
                        for (let cell of calendarRow.cells) {
                            if (cell.getAttribute('data-person') === event.type) {
                                const cellContent = document.createElement('div');
                                cellContent.innerText = event.content;
                                cellContent.dataset.event = event.content;
                                cellContent.classList.add('event');

                                const noteDiv = document.createElement('div');
                                noteDiv.classList.add('note');
                                noteDiv.innerText = event.note ? event.note : '';

                                if (event.content.includes('請假')) {
                                    cellContent.classList.add('leave');
                                }

                                cellContent.appendChild(noteDiv);
                                cell.appendChild(cellContent);
                                cell.style.backgroundColor = '#faf2e4';

                                cellContent.onclick = function() {
                                    if (!deleteMode) {
                                        noteDiv.style.display = noteDiv.style.display === 'block' ? 'none' : 'block';
                                    }
                                };

                                if (deleteMode) {
                                    cell.onclick = () => {
                                        if (confirm(`是否刪除此行程：${event.content}${event.note ? ` - ${event.note}` : ''}`)) {
                                            eventsData.splice(eventsData.indexOf(event), 1);
                                            saveEvents();
                                            renderEvents();
                                            updateStats();
                                            generateRecentReport();
                                        }
                                    };
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    function updateStats() {
        const stats = {
            '榮源': { bookfairDays: 0, bookfairTimes: [], leaveDays: 0 },
            '畀予': { bookfairDays: 0, bookfairTimes: [], leaveDays: 0 },
            '雅慧': { bookfairDays: 0, bookfairTimes: [], leaveDays: 0 },
            '凱琪': { bookfairDays: 0, bookfairTimes: [], leaveDays: 0 },
        };

        eventsData.forEach(event => {
            const person = event.type;
            const days = (new Date(event.endDate) - new Date(event.startDate)) / (1000 * 60 * 60 * 24) + 1;

            if (event.content.includes('書展')) {
                stats[person].bookfairDays += days;
                if (!stats[person].bookfairTimes.includes(event.content)) {
                    stats[person].bookfairTimes.push(event.content);
                }
            }

            if (event.content.includes('請假')) {
                stats[person].leaveDays += days;
            }
        });

        document.getElementById('stat-ry-days').innerText = stats['榮源'].bookfairDays;
        document.getElementById('stat-ry-times').innerText = stats['榮源'].bookfairTimes.length;
        document.getElementById('stat-ry-leave').innerText = stats['榮源'].leaveDays;
        document.getElementById('stat-py-days').innerText = stats['畀予'].bookfairDays;
        document.getElementById('stat-py-times').innerText = stats['畀予'].bookfairTimes.length;
        document.getElementById('stat-py-leave').innerText = stats['畀予'].leaveDays;
        document.getElementById('stat-yh-days').innerText = stats['雅慧'].bookfairDays;
        document.getElementById('stat-yh-times').innerText = stats['雅慧'].bookfairTimes.length;
        document.getElementById('stat-yh-leave').innerText = stats['雅慧'].leaveDays;
        document.getElementById('stat-kq-days').innerText = stats['凱琪'].bookfairDays;
        document.getElementById('stat-kq-times').innerText = stats['凱琪'].bookfairTimes.length;
        document.getElementById('stat-kq-leave').innerText = stats['凱琪'].leaveDays;
    }

    function saveEvents() {
        localStorage.setItem('eventsData', JSON.stringify(eventsData));
    }

    function loadEvents() {
        const storedEvents = localStorage.getItem('eventsData');
        if (storedEvents) {
            eventsData = JSON.parse(storedEvents);
            // Convert ISO string dates back to Date objects
            eventsData = eventsData.map(event => ({
                ...event,
                startDate: new Date(event.startDate),
                endDate: new Date(event.endDate)
            }));
        }
        renderEvents();
        updateStats();
        generateRecentReport();
    }

    function clearCurrentYearEvents() {
        if (confirm('確定要刪除今年度的所有設定嗎？')) {
            eventsData = eventsData.filter(event => {
                const startDate = new Date(event.startDate);
                return startDate.getFullYear() !== currentYear;
            });
            saveEvents();
            renderEvents();
            updateStats();
            generateRecentReport();
        }
    }

    function exportCSV() {
        let csvContent = "data:text/csv;charset=utf-8,";
        const rows = document.querySelectorAll("table tr");
        rows.forEach(row => {
            let rowArray = Array.from(row.querySelectorAll("th, td")).map(cell => cell.innerText.replace(/,/g, ''));
            csvContent += rowArray.join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "calendar.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function toggleDeleteMode() {
        deleteMode = !deleteMode;
        const body = document.querySelector('body');
        const deleteModeBtn = document.getElementById('delete-mode-btn');
        if (deleteMode) {
            body.classList.add('delete-mode');
            deleteModeBtn.classList.add('active');
        } else {
            body.classList.remove('delete-mode');
            deleteModeBtn.classList.remove('active');
        }
        renderEvents();
    }

    function generateRecentReport() {
        const reportContent = document.getElementById('report-content');
        const today = new Date();
        const reportData = {};

        // Iterate over the eventsData to generate the report
        eventsData.forEach(event => {
            const startDate = new Date(event.startDate);
            const endDate = new Date(event.endDate);

            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                const diffTime = date - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays >= 0 && diffDays <= 2) { // Only include events within the next 3 days
                    const targetDateString = `${date.getMonth() + 1}/${date.getDate()}`;
                    const key = `${targetDateString}:${event.content.includes('請假') ? '請假' : event.content}`;

                    if (!reportData[key]) {
                        reportData[key] = [];
                    }

                    if (event.type === '總會活動') {
                        reportData[key].push(event.content);
                    } else {
                        reportData[key].push(event.type);
                    }
                }
            }
        });

        // Sort report data by date
        const sortedReportData = Object.entries(reportData).sort((a, b) => {
            const dateA = new Date(a[0].split(':')[0]);
            const dateB = new Date(b[0].split(':')[0]);
            return dateA - dateB;
        });

        const reportOutput = sortedReportData.map(([key, values]) => `${key}: ${values.join(' ')}`).join('<br>');

        console.log('Generated report data:', reportOutput);
        reportContent.innerHTML = reportOutput.length > 0 ? reportOutput : '最近三天沒有活動';
    }

    function addHoliday() {
        const holidayDate = document.getElementById('holiday-date').value.trim();
        const holidayName = document.getElementById('holiday-name').value.trim();

        if (!holidayDate || !holidayName) {
            alert('請輸入完整的假期日期和名稱');
            return;
        }

        holidays[holidayDate] = holidayName;
        alert(`已新增或更新假期: ${holidayDate} - ${holidayName}`);
        generateCalendar(currentYear, currentMonth);
        renderEvents();
    }

    function removeHoliday() {
        const holidayDate = document.getElementById('holiday-date').value.trim();

        if (!holidayDate) {
            alert('請輸入要刪除的假期日期');
            return;
        }

        if (holidays[holidayDate] && holidayDate.startsWith(`${currentYear}/`)) {
            delete holidays[holidayDate];
            alert(`已刪除假期: ${holidayDate}`);
            generateCalendar(currentYear, currentMonth);
            renderEvents();
        } else {
            alert('找不到該日期的假期，或無法刪除非當年度的假期');
        }
    }
</script>
</body>
</html>
